<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>记账系统</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/element-plus@2.3.12/dist/index.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.3.12/dist/index.full.js"></script>
    <style>
      body {
        font-family: "Microsoft YaHei", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      }
      .chart-area {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
        height: 200px;
        position: relative;
        background-color: #f9f9f9;
        background-image: linear-gradient(#e5e5e5 1px, transparent 1px),
          linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
        background-size: 20px 20px;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        position: absolute;
      }
      .dot-blue {
        background-color: #409eff;
      }
      .dot-red {
        background-color: #f56c6c;
      }
      .stats-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      .stats-table th,
      .stats-table td {
        border: 1px solid #ebeef5;
        padding: 8px;
        text-align: center;
      }
      .stats-table th {
        background-color: #f2f6fc;
      }
      .yellow-bg {
        background-color: #fff9c4;
      }
      .pink-bg {
        background-color: #fce4ec;
      }
      .btn-group {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .btn-group button {
        flex: 1;
        margin: 0 5px;
      }
      .record-table {
        width: 100%;
        border-collapse: collapse;
      }
      .record-table th,
      .record-table td {
        border: 1px solid #ebeef5;
        padding: 8px;
        text-align: center;
      }
      .record-table .positive {
        color: #67c23a;
      }
      .record-table .negative {
        color: #f56c6c;
      }
      .input-area {
        display: flex;
        margin-bottom: 20px;
        align-items: center;
      }
      .input-area .el-input {
        margin-right: 10px;
      }
      /* 表格头部的黄色背景 */
      .record-table thead tr {
        background-color: #fff9c4;
      }
      /* 表格中正数显示为绿色，负数显示为红色 */
      .positive-value {
        color: #67c23a;
      }
      .negative-value {
        color: #f56c6c;
      }
      /* 按钮冷却状态样式 */
      .btn-cooldown {
        opacity: 0.7;
        cursor: not-allowed !important;
        pointer-events: none;
      }
      /* 为按钮添加点击动画效果 */
      .el-button {
        transition: all 0.2s ease;
      }
      .el-button:active {
        transform: scale(0.95);
      }

      /* 新增样式 */
      .input-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .input-group span {
        margin: 0 10px;
      }
      .input-label {
        min-width: 80px;
        text-align: right;
        margin-right: 10px;
      }
      .action-button {
        margin: 0 5px;
        flex: 1;
      }
      .button-row {
        display: flex;
        margin-bottom: 15px;
        justify-content: space-between;
      }
      .green-text {
        color: #67c23a;
        font-weight: bold;
      }
      .red-text {
        color: #f56c6c;
        font-weight: bold;
      }
      .action-row {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
      }
      .action-row button {
        flex: 1;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <h1>记账系统</h1>

      <!-- 添加统计小区域 -->
      <div
        class="stat-summary"
        style="
          margin-bottom: 15px;
          background-color: #f5f7fa;
          padding: 8px;
          border-radius: 4px;
          display: flex;
          align-items: center;
        "
      >
        <i class="el-icon-data-analysis" style="margin-right: 8px"></i>
        <span
          >赢: <b>{{ winBets }}</b> 输: <b>{{ totalBets - winBets }}</b> 净胜:
          <b>{{ winBets - (totalBets - winBets) }}</b></span
        >
      </div>

      <!-- 参数输入区 -->
      <div class="input-group" style="display: flex; margin-bottom: 20px">
        <div style="display: flex; align-items: center; margin-right: 20px">
          <span style="min-width: 60px; margin-right: 5px">随机值：</span>
          <div
            style="
              display: flex;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              overflow: hidden;
            "
          >
            <button
              style="
                width: 40px;
                border: none;
                background: #f5f7fa;
                cursor: pointer;
                padding: 5px 10px;
              "
              @click="decreaseRandomValue"
              title="减少随机值"
            >
              -
            </button>
            <input
              v-model="randomValue"
              style="
                width: 80px;
                border: none;
                text-align: center;
                padding: 5px 0;
              "
              title="随机值"
              placeholder="随机值"
            />
            <button
              style="
                width: 40px;
                border: none;
                background: #f5f7fa;
                cursor: pointer;
                padding: 5px 10px;
              "
              @click="increaseRandomValue"
              title="增加随机值"
            >
              +
            </button>
          </div>
        </div>

        <div style="display: flex; align-items: center">
          <span style="min-width: 60px; margin-right: 5px">投注值：</span>
          <div
            style="
              display: flex;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              overflow: hidden;
            "
          >
            <button
              style="
                width: 40px;
                border: none;
                background: #f5f7fa;
                cursor: pointer;
                padding: 5px 10px;
              "
              @click="decreaseBetValue"
              title="减少投注值"
            >
              -
            </button>
            <input
              v-model="betValue"
              style="
                width: 80px;
                border: none;
                text-align: center;
                padding: 5px 0;
              "
              title="投注值"
              placeholder="投注值"
            />
            <button
              style="
                width: 40px;
                border: none;
                background: #f5f7fa;
                cursor: pointer;
                padding: 5px 10px;
              "
              @click="increaseBetValue"
              title="增加投注值"
            >
              +
            </button>
          </div>
        </div>
      </div>

      <!-- 统计信息表格 -->
      <table class="stats-table">
        <tr>
          <td class="input-label">初始本金：</td>
          <td>
            <div style="display: flex; align-items: center">
              <el-button @click="decreaseInitialCapital">-</el-button>
              <el-input-number
                v-model="initialCapital"
                :min="1000"
                :step="1000"
                :controls="false"
                style="width: 100px"
                @change="updateStats"
              ></el-input-number>
              <el-button @click="increaseInitialCapital">+</el-button>
            </div>
          </td>
          <td class="yellow-bg">总体对报</td>
          <td class="yellow-bg">回合对报</td>
          <td>流水：{{ totalTurnover }}</td>
          <td>压胜率：{{ (winRate * 100).toFixed(2) }}</td>
        </tr>
        <tr>
          <td>当前本金：{{ currentCapital }}</td>
          <td>口数：{{ totalBets }}</td>
          <td>口数：{{ currentRoundBets }}</td>
          <td>均利：{{ averageProfit.toFixed(2) }}</td>
          <td>评顺率：{{ sequenceRate.toFixed(2) }}</td>
        </tr>
        <tr>
          <td>偷鸡盈利合计：{{ sneakyProfitTotal }}</td>
          <td>赢口数：{{ winBets }}</td>
          <td>赢口数：{{ currentWinBets }}</td>
          <td>当前连胜/输：{{ currentStreak }}</td>
          <td>评顺率：{{ (sequenceRate * 100).toFixed(2) }}%</td>
        </tr>
        <tr>
          <td>均积赢：{{ averageWinAmount.toFixed(1) }}</td>
          <td>赢率：{{ (winRate * 100).toFixed(2) }}%</td>
          <td>赢率：{{ (currentWinRate * 100).toFixed(2) }}%</td>
          <td>最高盈利：{{ highestProfit }}</td>
          <td>1</td>
        </tr>
        <tr>
          <td>均积输：{{ averageLossAmount.toFixed(1) }}</td>
          <td>
            盈利：<span
              :class="{'positive-value': totalProfit > 0, 'negative-value': totalProfit < 0, 'green-text': totalProfit > 0, 'red-text': totalProfit < 0}"
              >{{ totalProfit }}</span
            >
          </td>
          <td>
            盈利：<span
              :class="{'positive-value': currentProfit > 0, 'negative-value': currentProfit < 0, 'green-text': currentProfit > 0, 'red-text': currentProfit < 0}"
              >{{ currentProfit }}</span
            >
          </td>
          <td>最高亏损：{{ highestLoss }}</td>
          <td>超额：{{ excessAmount }}</td>
        </tr>
        <tr>
          <td class="pink-bg">
            随机投注：<el-button
              size="small"
              @click="toggleRandomBet"
              :class="{'btn-cooldown': buttonCooldowns.toggleRandomBet}"
              >{{ isRandomBet ? '任' : '定' }}</el-button
            >
          </td>
          <td>可负全金额：{{ maxLossAllowed }}</td>
          <td>可负金额口数：{{ maxLossBets.toFixed(2) }}</td>
          <td></td>
          <td>50</td>
        </tr>
      </table>

      <!-- 操作按钮区域 -->
      <div class="action-row">
        <el-button
          size="small"
          @click="randomDirection"
          :class="{'btn-cooldown': buttonCooldowns.randomDirection}"
          >随机方向</el-button
        >
        <el-button
          size="small"
          @click="undoLastRecord"
          :class="{'btn-cooldown': buttonCooldowns.undoLastRecord}"
          >记录回退</el-button
        >
        <el-button
          size="small"
          @click="restartRound"
          :class="{'btn-cooldown': buttonCooldowns.restartRound}"
          >重启回合</el-button
        >
        <el-button
          size="small"
          @click="clearAllRecords"
          :class="{'btn-cooldown': buttonCooldowns.clearAllRecords}"
          >删除全部</el-button
        >
      </div>

      <!-- 按钮区域 -->
      <div class="btn-group">
        <el-button
          type="danger"
          @click="addRecord('playerLoss')"
          :class="{'btn-cooldown': buttonCooldowns.playerLoss}"
          >闲输</el-button
        >
        <el-button
          type="danger"
          @click="addRecord('playerWin')"
          :class="{'btn-cooldown': buttonCooldowns.playerWin}"
          >闲赢</el-button
        >
        <el-button
          type="primary"
          @click="addRecord('bankerLoss')"
          :class="{'btn-cooldown': buttonCooldowns.bankerLoss}"
          >庄输</el-button
        >
        <el-button
          type="primary"
          @click="addRecord('bankerWin')"
          :class="{'btn-cooldown': buttonCooldowns.bankerWin}"
          >庄赢</el-button
        >
      </div>

      <!-- 记录表格 -->
      <table class="record-table">
        <thead>
          <tr class="yellow-bg">
            <th>每口输赢</th>
            <th>偷鸡输赢</th>
            <th>下注金额</th>
            <th>最终/原始胜负路</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(record, index) in records" :key="index">
            <td
              :class="{'positive': record.profit > 0, 'negative': record.profit < 0, 'green-text': record.profit > 0, 'red-text': record.profit < 0}"
            >
              {{ record.profit }}
            </td>
            <td
              :class="{'positive': record.sneakyProfit > 0, 'negative': record.sneakyProfit < 0, 'green-text': record.sneakyProfit > 0, 'red-text': record.sneakyProfit < 0}"
            >
              {{ record.sneakyProfit || '-' }}
            </td>
            <td>{{ record.betAmount || Math.abs(record.profit) }}</td>
            <td>
              <span v-if="record.result === 'win'" class="positive">+</span>
              <span v-else class="negative">-</span>
              <span style="margin-left: 20px">
                <span v-if="record.sequence === 'win'" class="positive">+</span>
                <span v-else class="negative">-</span>
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted, computed, watch } = Vue;
      const { ElMessageBox, ElMessage } = ElementPlus;

      const app = createApp({
        setup() {
          // 基础数据
          const initialCapital = ref(5000);
          const currentCapital = ref(6221);
          const randomValue = ref(10000);
          const betValue = ref(2000);
          const chartArea = ref(null);
          const isRandomBet = ref(true); // 控制是否使用随机投注额

          // 防抖节流控制
          const buttonCooldowns = reactive({
            playerLoss: false,
            playerWin: false,
            bankerLoss: false,
            bankerWin: false,
            randomDirection: false,
            undoLastRecord: false,
            restartRound: false,
            clearAllRecords: false,
            toggleRandomBet: false,
          });

          // 设置按钮冷却
          const setCooldown = (buttonName, duration = 500) => {
            if (buttonCooldowns[buttonName]) return false;

            buttonCooldowns[buttonName] = true;
            setTimeout(() => {
              buttonCooldowns[buttonName] = false;
            }, duration);

            return true;
          };

          // 统计数据
          const totalBets = ref(219);
          const winBets = ref(117);
          const totalProfit = ref(1221);
          const currentWinBets = ref(47);
          const currentProfit = ref(1262);
          const sneakyProfitTotal = ref(0);
          const totalTurnover = ref(11109);
          const highestProfit = ref(1321);
          const highestLoss = ref(41);
          const excessAmount = ref(512);
          const maxLossAllowed = ref(1210);
          const maxLossBets = ref(83.87);

          // 连胜连输记录
          const currentWinStreak = ref(0);
          const currentLossStreak = ref(1);
          const maxWinStreak = ref(4);
          const maxLossStreak = ref(3);

          // 计算属性
          const profitRate = computed(
            () => winBets.value / (totalBets.value > 0 ? totalBets.value : 1)
          );
          const currentProfitRate = computed(
            () =>
              currentWinBets.value / (totalBets.value > 0 ? totalBets.value : 1)
          );
          const averageProfit = computed(
            () =>
              totalProfit.value / (totalBets.value > 0 ? totalBets.value : 1)
          );
          const averageWinAmount = computed(
            () => totalProfit.value / (winBets.value > 0 ? winBets.value : 1)
          );
          const averageLossAmount = computed(() => {
            const lossBets = totalBets.value - winBets.value;
            return lossBets > 0
              ? (totalProfit.value - totalProfit.value) / lossBets
              : 0;
          });
          const winRate = computed(
            () => winBets.value / (totalBets.value > 0 ? totalBets.value : 1)
          );
          const sequenceRate = computed(() => 1); // 假设顺序率固定为1
          const currentStreak = computed(
            () => `${currentWinStreak.value}/${currentLossStreak.value}`
          );
          const totalStreak = computed(
            () => `${maxWinStreak.value}/${maxLossStreak.value}`
          );

          // 新增计算属性
          const currentRoundBets = computed(() => {
            // 获取当前回合的下注次数，这里可以根据实际需求调整
            return currentWinBets.value + currentLossStreak.value;
          });

          const currentWinRate = computed(() => {
            return (
              currentWinBets.value /
              (currentRoundBets.value > 0 ? currentRoundBets.value : 1)
            );
          });

          // 记录数据
          const records = reactive([
            {
              profit: 42,
              sneakyProfit: 2,
              betAmount: 45,
              result: "win",
              sequence: "win",
            },
            {
              profit: -45,
              sneakyProfit: null,
              betAmount: 45,
              result: "loss",
              sequence: "loss",
            },
            {
              profit: 42,
              sneakyProfit: 2,
              betAmount: 45,
              result: "win",
              sequence: "win",
            },
            {
              profit: -45,
              sneakyProfit: null,
              betAmount: 45,
              result: "loss",
              sequence: "loss",
            },
            {
              profit: 40,
              sneakyProfit: 2,
              betAmount: 43,
              result: "win",
              sequence: "win",
            },
            {
              profit: -42,
              sneakyProfit: null,
              betAmount: 42,
              result: "loss",
              sequence: "loss",
            },
            {
              profit: 40,
              sneakyProfit: 2,
              betAmount: 43,
              result: "win",
              sequence: "win",
            },
          ]);

          // 初始化点阵图
          const initDotMatrix = () => {
            try {
              if (!chartArea.value) return;

              // 清空图表区域
              chartArea.value.innerHTML = "";

              // 创建点阵图
              const width = chartArea.value.clientWidth;
              const height = chartArea.value.clientHeight;
              const dotSize = 12;
              const dotSpacing = 16;
              const rows = 4; // 根据图片调整为4行
              const cols = Math.floor(width / dotSpacing);

              // 模拟图片中的点阵模式
              // 第一行和第二行
              const dotPattern1 = [
                "blue",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "blue",
              ];

              // 第三行和第四行
              const dotPattern2 = [
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
                "blue",
                "blue",
                "red",
                "red",
              ];

              // 生成完整的点阵数据 - 复制图片中的模式
              const dotData = [];
              for (let r = 0; r < rows; r++) {
                if (r % 2 === 0) {
                  dotData.push([...dotPattern1]);
                } else {
                  dotData.push([...dotPattern2]);
                }
              }

              // 渲染点阵图
              dotData.forEach((row, rowIndex) => {
                row.forEach((color, colIndex) => {
                  const dot = document.createElement("div");
                  dot.className = `dot dot-${color}`;
                  dot.style.left = `${colIndex * dotSpacing}px`;
                  dot.style.top = `${rowIndex * dotSpacing + 30}px`;
                  chartArea.value.appendChild(dot);
                });
              });
            } catch (error) {
              console.error("初始化点阵图出错:", error);
            }
          };

          // 初始化统计数据
          const initializeStats = () => {
            // 重新计算所有统计数据
            let totalWins = 0;
            let totalLosses = 0;
            let currentWins = 0;
            let currentLosses = 0;
            let totalProfitValue = 0;
            let currentProfitValue = 0;
            let highestProfitValue = 0;
            let highestLossValue = 0;
            let totalTurnoverValue = 0;
            let sneakyProfitValue = 0;
            let currentWinStreakValue = 0;
            let currentLossStreakValue = 0;
            let maxWinStreakValue = 0;
            let maxLossStreakValue = 0;

            // 计算连胜连输
            let tempWinStreak = 0;
            let tempLossStreak = 0;

            records.forEach((record, index) => {
              if (record.result === "win") {
                totalWins++;
                currentWins++;
                totalProfitValue += record.profit;
                currentProfitValue += record.profit;

                if (record.profit > highestProfitValue) {
                  highestProfitValue = record.profit;
                }

                // 处理连胜
                tempWinStreak++;
                tempLossStreak = 0;
                if (tempWinStreak > maxWinStreakValue) {
                  maxWinStreakValue = tempWinStreak;
                }
              } else {
                totalLosses++;
                currentLosses++;

                if (Math.abs(record.profit) > highestLossValue) {
                  highestLossValue = Math.abs(record.profit);
                }

                // 处理连输
                tempLossStreak++;
                tempWinStreak = 0;
                if (tempLossStreak > maxLossStreakValue) {
                  maxLossStreakValue = tempLossStreak;
                }
              }

              // 更新偷鸡盈利
              if (record.sneakyProfit) {
                sneakyProfitValue += record.sneakyProfit;
              }

              totalTurnoverValue += Math.abs(record.profit);
            });

            // 更新统计数据
            totalBets.value = totalWins + totalLosses;
            winBets.value = totalWins;
            totalProfit.value = totalProfitValue;
            currentWinBets.value = currentWins;
            currentProfit.value = currentProfitValue;
            sneakyProfitTotal.value = sneakyProfitValue;
            totalTurnover.value = totalTurnoverValue;
            highestProfit.value = highestProfitValue;
            highestLoss.value = highestLossValue;
            currentWinStreak.value = tempWinStreak;
            currentLossStreak.value = tempLossStreak;
            maxWinStreak.value = maxWinStreakValue;
            maxLossStreak.value = maxLossStreakValue;

            // 更新可负全金额
            maxLossAllowed.value = Math.round(currentCapital.value * 0.2);
            maxLossBets.value = maxLossAllowed.value / betValue.value;
          };

          // 添加记录
          const addRecord = (type) => {
            if (!setCooldown(type)) return; // 如果按钮在冷却中，不执行操作

            try {
              let profit = 0;
              let result = "";
              // 获取投注额，根据是否随机投注决定
              const actualBetAmount = isRandomBet.value
                ? getRandomBetAmount()
                : betValue.value;

              if (type === "playerWin") {
                profit = -actualBetAmount;
                result = "loss";
              } else if (type === "playerLoss") {
                profit = actualBetAmount;
                result = "win";
              } else if (type === "bankerWin") {
                profit = actualBetAmount;
                result = "win";
              } else if (type === "bankerLoss") {
                profit = -actualBetAmount;
                result = "loss";
              }

              // 计算偷鸡盈利（示例逻辑，可根据实际需求调整）
              const sneakyProfit =
                result === "win" ? Math.round(profit * 0.05) : null;

              const newRecord = {
                profit,
                sneakyProfit,
                betAmount: actualBetAmount,
                result,
                sequence: result,
                timestamp: new Date().toISOString(),
              };

              // 使用Vue的响应式API来确保数组更新被正确跟踪
              records.unshift(newRecord);

              // 更新统计数据
              updateStats(profit, result, sneakyProfit, newRecord);

              // 保存到本地存储
              saveToLocalStorage();

              // 给用户一些简单的视觉反馈
              ElMessage({
                message: `${getDirectionName(type)}: ${
                  result === "win" ? "+" : "-"
                }${Math.abs(profit)}`,
                type: result === "win" ? "success" : "warning",
                duration: 1000,
              });
            } catch (error) {
              console.error("添加记录时出错:", error);
              ElMessage.error("操作失败，请重试");
            }
          };

          // 更新统计数据
          const updateStats = (profit, result, sneakyProfit, newRecord) => {
            try {
              if (profit !== undefined && result !== undefined) {
                // 这是正常的记录更新
                currentCapital.value += profit;
                totalBets.value += 1;

                if (result === "win") {
                  winBets.value += 1;
                  currentWinBets.value += 1;
                  totalProfit.value += profit;
                  currentProfit.value += profit;

                  // 更新连胜连输
                  currentWinStreak.value += 1;
                  currentLossStreak.value = 0;
                  if (currentWinStreak.value > maxWinStreak.value) {
                    maxWinStreak.value = currentWinStreak.value;
                  }

                  if (profit > highestProfit.value) {
                    highestProfit.value = profit;
                  }
                } else {
                  // 更新连胜连输
                  currentLossStreak.value += 1;
                  currentWinStreak.value = 0;
                  if (currentLossStreak.value > maxLossStreak.value) {
                    maxLossStreak.value = currentLossStreak.value;
                  }

                  if (Math.abs(profit) > highestLoss.value) {
                    highestLoss.value = Math.abs(profit);
                  }
                }

                // 更新偷鸡盈利
                if (sneakyProfit) {
                  sneakyProfitTotal.value += sneakyProfit;
                }

                totalTurnover.value += Math.abs(profit);

                // 更新可负全金额
                maxLossAllowed.value = Math.round(currentCapital.value * 0.2);
                maxLossBets.value = maxLossAllowed.value / betValue.value;
              } else {
                // 这是手动调整初始本金
                maxLossAllowed.value = Math.round(currentCapital.value * 0.2);
                maxLossBets.value = maxLossAllowed.value / betValue.value;
              }
            } catch (error) {
              console.error("更新统计数据时出错:", error);
            }
          };

          // 分析近期趋势并提供建议
          const analyzeTrend = () => {
            // 删除整个方法，但保留空函数以避免引用错误
          };

          // 撤销最后一条记录
          const undoLastRecord = () => {
            if (!setCooldown("undoLastRecord")) return; // 如果按钮在冷却中，不执行操作

            try {
              if (records.length > 0) {
                // 复制第一条记录，然后删除
                const lastRecord = { ...records[0] }; // 复制一份，避免引用问题

                // 使用更安全的方式移除第一条记录
                records.splice(0, 1);

                // 恢复统计数据
                currentCapital.value -= lastRecord.profit;
                totalBets.value -= 1;

                if (lastRecord.result === "win") {
                  winBets.value -= 1;
                  currentWinBets.value -= 1;
                  totalProfit.value -= lastRecord.profit;
                  currentProfit.value -= lastRecord.profit;

                  // 更新连胜连输
                  if (currentWinStreak.value > 0) {
                    currentWinStreak.value -= 1;
                  }
                } else {
                  // 更新连胜连输
                  if (currentLossStreak.value > 0) {
                    currentLossStreak.value -= 1;
                  }
                }

                // 恢复偷鸡盈利
                if (lastRecord.sneakyProfit) {
                  sneakyProfitTotal.value -= lastRecord.sneakyProfit;
                }

                totalTurnover.value -= lastRecord.profit;

                // 保存到本地存储
                saveToLocalStorage();

                ElMessage.success("已撤销最后一条记录");
              } else {
                ElMessage.warning("没有记录可以撤销");
              }
            } catch (error) {
              console.error("撤销记录时出错:", error);
              ElMessage.error("操作失败，请重试");
            }
          };

          // 重启回合
          const restartRound = () => {
            if (!setCooldown("restartRound")) return; // 如果按钮在冷却中，不执行操作

            try {
              // 保留总统计数据，但重置当前回合数据
              currentWinBets.value = 0;
              currentProfit.value = 0;
              currentWinStreak.value = 0;
              currentLossStreak.value = 0;

              // 保存到本地存储
              saveToLocalStorage();

              // 可以在这里添加回合相关的逻辑
              ElMessage({
                message: "已重启新回合",
                type: "success",
              });
            } catch (error) {
              console.error("重启回合时出错:", error);
              ElMessage.error("操作失败，请重试");
            }
          };

          // 清空所有记录
          const clearAllRecords = () => {
            if (!setCooldown("clearAllRecords")) return; // 如果按钮在冷却中，不执行操作

            try {
              ElMessageBox.confirm("确定要删除所有记录吗?", "提示", {
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                type: "warning",
              })
                .then(() => {
                  try {
                    // 使用splice清空数组以保持响应性
                    records.splice(0, records.length);

                    // 重置统计数据
                    currentCapital.value = initialCapital.value;
                    totalBets.value = 0;
                    winBets.value = 0;
                    totalProfit.value = 0;
                    currentWinBets.value = 0;
                    currentProfit.value = 0;
                    sneakyProfitTotal.value = 0;
                    totalTurnover.value = 0;
                    highestProfit.value = 0;
                    highestLoss.value = 0;
                    currentWinStreak.value = 0;
                    currentLossStreak.value = 0;
                    maxWinStreak.value = 0;
                    maxLossStreak.value = 0;

                    // 保存到本地存储
                    saveToLocalStorage();

                    ElMessage({
                      message: "已清空所有记录",
                      type: "success",
                    });
                  } catch (error) {
                    console.error("清空记录时出错:", error);
                    ElMessage.error("操作失败，请重试");
                  }
                })
                .catch(() => {
                  ElMessage({
                    message: "已取消删除",
                    type: "info",
                  });
                });
            } catch (error) {
              console.error("清空记录操作出错:", error);
              alert("删除操作失败，请重试");
            }
          };

          // 随机方向功能
          const randomDirection = () => {
            if (!setCooldown("randomDirection")) return; // 如果按钮在冷却中，不执行操作

            try {
              const directions = [
                "playerLoss",
                "playerWin",
                "bankerLoss",
                "bankerWin",
              ];
              const randomIndex = Math.floor(Math.random() * directions.length);
              // 直接执行逻辑，不通过addRecord调用，避免重复的冷却检查
              let type = directions[randomIndex];
              let profit = 0;
              let result = "";

              // 获取投注额，根据是否随机投注决定
              const actualBetAmount = isRandomBet.value
                ? getRandomBetAmount()
                : betValue.value;

              if (type === "playerWin") {
                profit = -actualBetAmount;
                result = "loss";
              } else if (type === "playerLoss") {
                profit = actualBetAmount;
                result = "win";
              } else if (type === "bankerWin") {
                profit = actualBetAmount;
                result = "win";
              } else if (type === "bankerLoss") {
                profit = -actualBetAmount;
                result = "loss";
              }

              // 计算偷鸡盈利
              const sneakyProfit =
                result === "win" ? Math.round(profit * 0.05) : null;

              const newRecord = {
                profit,
                sneakyProfit,
                betAmount: actualBetAmount,
                result,
                sequence: result,
                timestamp: new Date().toISOString(),
              };

              records.unshift(newRecord);
              updateStats(profit, result, sneakyProfit, newRecord);
              saveToLocalStorage();

              ElMessage.info(`随机选择了: ${getDirectionName(type)}`);
            } catch (error) {
              console.error("随机方向选择时出错:", error);
              ElMessage.error("操作失败，请重试");
            }
          };

          // 获取方向名称
          const getDirectionName = (direction) => {
            switch (direction) {
              case "playerLoss":
                return "闲输";
              case "playerWin":
                return "闲赢";
              case "bankerLoss":
                return "庄输";
              case "bankerWin":
                return "庄赢";
              default:
                return "未知";
            }
          };

          // 随机生成投注额
          const getRandomBetAmount = () => {
            // 在当前投注额的基础上随机上下浮动20%
            const baseAmount = betValue.value;
            const variation = baseAmount * 0.2; // 20%的浮动范围
            return Math.round(baseAmount + (Math.random() * 2 - 1) * variation);
          };

          // 增减随机值的方法
          const increaseRandomValue = () => {
            randomValue.value = Number(randomValue.value) + 1000;
            saveToLocalStorage();
          };

          const decreaseRandomValue = () => {
            if (Number(randomValue.value) >= 2000) {
              randomValue.value = Number(randomValue.value) - 1000;
              saveToLocalStorage();
            }
          };

          // 增减投注值的方法
          const increaseBetValue = () => {
            betValue.value = Number(betValue.value) + 500;
            saveToLocalStorage();
          };

          const decreaseBetValue = () => {
            if (Number(betValue.value) >= 1000) {
              betValue.value = Number(betValue.value) - 500;
              saveToLocalStorage();
            }
          };

          // 增减初始本金的方法
          const increaseInitialCapital = () => {
            initialCapital.value = Number(initialCapital.value) + 5000;
            updateStats();
            saveToLocalStorage();
          };

          const decreaseInitialCapital = () => {
            if (Number(initialCapital.value) >= 10000) {
              initialCapital.value = Number(initialCapital.value) - 5000;
              updateStats();
              saveToLocalStorage();
            }
          };

          // 监听资金变化
          watch(currentCapital, (newValue) => {
            // 根据资金变化可以进行一些额外的处理
            if (newValue < initialCapital.value * 0.5) {
              ElMessage.warning("当前资金已低于初始资金的50%，请注意风险！");
            }

            // 自动保存到本地存储
            saveToLocalStorage();
          });

          // 切换随机投注模式
          const toggleRandomBet = () => {
            if (!setCooldown("toggleRandomBet")) return; // 如果按钮在冷却中，不执行操作

            try {
              isRandomBet.value = !isRandomBet.value;

              // 保存到本地存储
              saveToLocalStorage();

              ElMessage.info(
                `已切换为${isRandomBet.value ? "随机" : "固定"}投注额模式`
              );
            } catch (error) {
              console.error("切换投注模式时出错:", error);
              ElMessage.error("操作失败，请重试");
            }
          };

          // 保存数据到本地存储
          const saveToLocalStorage = () => {
            try {
              const dataToSave = {
                initialCapital: initialCapital.value,
                currentCapital: currentCapital.value,
                randomValue: randomValue.value,
                betValue: betValue.value,
                isRandomBet: isRandomBet.value,
                stats: {
                  totalBets: totalBets.value,
                  winBets: winBets.value,
                  totalProfit: totalProfit.value,
                  currentWinBets: currentWinBets.value,
                  currentProfit: currentProfit.value,
                  sneakyProfitTotal: sneakyProfitTotal.value,
                  totalTurnover: totalTurnover.value,
                  highestProfit: highestProfit.value,
                  highestLoss: highestLoss.value,
                  excessAmount: excessAmount.value,
                  maxLossAllowed: maxLossAllowed.value,
                  maxLossBets: maxLossBets.value,
                  currentWinStreak: currentWinStreak.value,
                  currentLossStreak: currentLossStreak.value,
                  maxWinStreak: maxWinStreak.value,
                  maxLossStreak: maxLossStreak.value,
                },
                records: records,
                lastSaved: new Date().toISOString(),
              };

              localStorage.setItem(
                "accountingData",
                JSON.stringify(dataToSave)
              );
            } catch (error) {
              console.error("保存到本地存储失败:", error);
            }
          };

          // 从本地存储加载数据
          const loadFromLocalStorage = () => {
            try {
              const savedData = localStorage.getItem("accountingData");
              if (savedData) {
                const parsedData = JSON.parse(savedData);

                // 设置基础数据
                initialCapital.value = parsedData.initialCapital || 5000;
                currentCapital.value = parsedData.currentCapital || 5000;
                randomValue.value = parsedData.randomValue || 10000;
                betValue.value = parsedData.betValue || 2000;
                isRandomBet.value =
                  parsedData.isRandomBet !== undefined
                    ? parsedData.isRandomBet
                    : true;

                // 设置统计数据
                if (parsedData.stats) {
                  totalBets.value = parsedData.stats.totalBets || 0;
                  winBets.value = parsedData.stats.winBets || 0;
                  totalProfit.value = parsedData.stats.totalProfit || 0;
                  currentWinBets.value = parsedData.stats.currentWinBets || 0;
                  currentProfit.value = parsedData.stats.currentProfit || 0;
                  sneakyProfitTotal.value =
                    parsedData.stats.sneakyProfitTotal || 0;
                  totalTurnover.value = parsedData.stats.totalTurnover || 0;
                  highestProfit.value = parsedData.stats.highestProfit || 0;
                  highestLoss.value = parsedData.stats.highestLoss || 0;
                  excessAmount.value = parsedData.stats.excessAmount || 0;
                  maxLossAllowed.value = parsedData.stats.maxLossAllowed || 0;
                  maxLossBets.value = parsedData.stats.maxLossBets || 0;
                  currentWinStreak.value =
                    parsedData.stats.currentWinStreak || 0;
                  currentLossStreak.value =
                    parsedData.stats.currentLossStreak || 0;
                  maxWinStreak.value = parsedData.stats.maxWinStreak || 0;
                  maxLossStreak.value = parsedData.stats.maxLossStreak || 0;
                }

                // 设置记录数据
                if (parsedData.records && Array.isArray(parsedData.records)) {
                  records.splice(0, records.length);
                  parsedData.records.forEach((record) => {
                    records.push(record);
                  });
                }

                return true;
              }
              return false;
            } catch (error) {
              console.error("从本地存储加载失败:", error);
              return false;
            }
          };

          // 页面加载后初始化
          onMounted(() => {
            initDotMatrix();

            // 尝试从本地存储加载数据，如果没有则初始化统计数据
            if (!loadFromLocalStorage()) {
              initializeStats();
            }
          });

          return {
            // 基础数据
            initialCapital,
            currentCapital,
            randomValue,
            betValue,
            chartArea,
            isRandomBet,
            buttonCooldowns,

            // 统计数据
            totalBets,
            winBets,
            totalProfit,
            currentWinBets,
            currentProfit,
            sneakyProfitTotal,
            totalTurnover,
            highestProfit,
            highestLoss,
            excessAmount,
            maxLossAllowed,
            maxLossBets,
            currentWinStreak,
            currentLossStreak,
            maxWinStreak,
            maxLossStreak,

            // 计算属性
            profitRate,
            currentProfitRate,
            averageProfit,
            averageWinAmount,
            averageLossAmount,
            winRate,
            sequenceRate,
            currentStreak,
            totalStreak,
            currentRoundBets,
            currentWinRate,

            // 记录数据
            records,

            // 方法
            addRecord,
            undoLastRecord,
            restartRound,
            clearAllRecords,
            randomDirection,
            toggleRandomBet,
            updateStats,

            // 新增加的方法
            increaseRandomValue,
            decreaseRandomValue,
            increaseBetValue,
            decreaseBetValue,
            increaseInitialCapital,
            decreaseInitialCapital,
          };
        },
      });

      app.use(ElementPlus);
      app.mount("#app");
    </script>
  </body>
</html>
